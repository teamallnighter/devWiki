<h1>PaymentResponse.retry</h1><div class="blockIndicator secureContexts"><p><strong>Secure context</strong><br>This feature is available only in <a href="https://developer.mozilla.org/en-US/docs/Web/Security/Secure_Contexts">secure contexts</a> (HTTPS), in some or all <a href="#Browser_compatibility">supporting browsers</a>.</p></div> <p>The <a href="../paymentresponse"><code>PaymentResponse</code></a> interface's <code><strong>reply()</strong></code> method makes it possible to ask the user to retry a payment after an error occurs during processing. This lets your app gracefully deal with situations such as invalid shipping addresses or declined credit cards.</p> <h2 id="Syntax">Syntax</h2> <pre class="syntaxbox"><em>retryPromise</em> = <em>paymentRequest</em>.retry(<em>errorFields</em>);
</pre> <h3 id="Parameters">Parameters</h3> <dl> <dt><code>errorFields</code></dt> <dd> <p>A <a href="../paymentvalidationerrors"><code>PaymentValidationErrors</code></a> object, with the following properties:</p> 
<dl> <dt>
<a href="https://developer.mozilla.org/en-US/docs/Web/API/PyamentValidationErrors/error"><code>error</code></a> <span class="inlineIndicator optional optionalInline">Optional</span>
</dt> <dd>A general description of a payment error from which the user may attempt to recover by retrying the payment, possibly after correcting mistakes in the payment information. <code>error</code> can be provided all by itself to provide only a generic error message, or in concert with the other properties to serve as an overview while other properties' values gude the user to errors in specific fields in the payment form.</dd> <dt>
<a href="https://developer.mozilla.org/en-US/docs/Web/API/PaymentValidationErrors/payer"><code>payer</code></a> <span class="inlineIndicator optional optionalInline">Optional</span>
</dt> <dd>A <a href="../payererrors"><code>PayerErrors</code></a> compliant object which provides appropriate error messages for any of the fields describing the payer which failed validation.</dd> <dt>
<a href="https://developer.mozilla.org/en-US/docs/Web/API/PaymentValidationErrors/paymentMethod"><code>paymentMethod</code></a> <span class="inlineIndicator optional optionalInline">Optional</span>
</dt> <dd>Any payment method specific errors which may have occurred. This object's contents will vary depending on the payment used. For example, if the user chose to pay by credit card using the <code>basic-card</code> payment method, this is a <a href="https://developer.mozilla.org/en-US/docs/Web/API/BasicCardErrors"><code>BasicCardErrors</code></a> object.</dd> </dl> <dl> <dt>
<a href="https://developer.mozilla.org/en-US/docs/Web/API/PaymentValidationErrorsi/shippingAddress"><code>shippingAddress</code></a> <span class="inlineIndicator optional optionalInline">Optional</span>
</dt> <dd>An <a href="../addresserrors"><code>AddressErrors</code></a> object which contains error messages for any of the fields in the shipping address that failed validation.</dd> </dl>
 </dd> </dl> <h3 id="Return_value">Return value</h3> <p>A <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise"><code>Promise</code></a> which is resolved when the payment is successfully completed. The promise is rejected with an appropriate exception value if the payment fails again.</p> <p>Typically you will use this by calling <a href="../paymentrequest/show"><code>show()</code></a>, then entering a loop or recursive function that checks the <a href="../paymentresponse"><code>PaymentResponse</code></a> for errors or other reasons to retry the payment request. If a retry is needed, the loop calls <code>retry()</code>, then loops back to check the response when it comes in. The loop exits only when the user either cancels the payment request or the request is successful.</p> <p>See the <a href="#Examples">example</a> below for a thorough example, but the basic concept, in outline form, is:</p> <ol> <li>Create a new <a href="../paymentrequest"><code>PaymentRequest</code></a> (<code>new </code><a href="../paymentrequest/paymentrequest"><code>PaymentRequest()</code></a>)</li> <li>Display the payment request (<a href="../paymentrequest/show"><code>PaymentRequest.show()</code></a>
</li> <li>If <code>show()</code> resolves, the returned <a href="../paymentresponse"><code>PaymentResponse</code></a> describes the completed payment; the process is complete, and no further steps are taken</li> <li>If <code>show()</code> is rejected,</li> </ol> <pre data-language="js">async function handlePayment() {
  const payRequest = new PaymentRequest(methodData, details, options);
  let payResponse = await payRequest.show();

  while (payResponse has errors) {
    /* let the user edit the payment information,
       wait until they submit */
    await response.retry();
  }
  await payResponse.complete("success");
}
</pre> <h2 id="Examples">Examples</h2> <p><u><strong>try { await paymentRequest.retry(errorFields); } catch (DOMException err) { ... }</strong></u></p> <pre data-language="JS">async function doPaymentRequest() {
  const request = new PaymentRequest(methodData, details, options);
  const response = await request.show();
  await recursiveValidate(request, response);
  await response.complete("success");
}

// Keep validating until the data looks good!
async function recursiveValidate(request, response) {
  const promisesToFixThings = [];
  const errors = await validate(request, response);
  if (!errors) {
    return;
  }
  if (errors.shippingAddress) {
Â    // "shippingaddresschange" fired at request object
    const promise = fixField(request, "shippingaddresschange", shippingValidator);
    promisesToFixThings.push(promise);
  }
  if (errors.payer) {
    // "payerdetailchange" fired at response object
    const promise = fixField(response, "payerdetailchange", payerValidator);
    promisesToFixThings.push(promise);
  }
  await Promise.all([response.retry(errors), ...promisesToFixThings]);
  await recursiveValidate(request, response);
}

function fixField(requestOrResponse, event, validator) {
  return new Promise(resolve =&gt; {
    // Browser keeps calling this until promise resolves.
    requestOrResponse.addEventListener(event, async function listener(ev) {
      const promiseToValidate = validator(requestOrResponse);
      ev.updateWith(promiseToValidate);
      const errors = await promiseToValidate;
      if (!errors) { // yay! fixed!
        event.removeEventListener(event, listener);
        resolve();
      }
    });
  });
}

doPaymentRequest();
</pre> <h2 id="Specifications">Specifications</h2> <div class="_table"><table class="standard-table"> <tbody> <tr> <th scope="col">Specification</th> <th scope="col">Status</th> <th scope="col">Comment</th> </tr> <tr> <td><a href="https://w3c.github.io/payment-request/#dom-paymentresponse-retry" hreflang="en">Payment Request API<br><small>The definition of 'retry()' in that specification.</small></a></td> <td><span class="spec-CR">Candidate Recommendation</span></td> <td>Initial definition.</td> </tr> </tbody> </table></div> <h2 id="Browser_compatibility">Browser compatibility</h2>   <p>No compatibility data found. Please contribute data for "api.PaymentRequest.retry" (depth: 1) to the <a href="https://github.com/mdn/browser-compat-data">MDN compatibility data repository</a>.</p>  <h2 id="See_also">See also</h2> <ul> <li>
<a href="../paymentresponse"><code>PaymentResponse</code></a> interface.</li> </ul><div class="_attribution">
  <p class="_attribution-p">
    <a href="https://developer.mozilla.org/en-US/docs/Web/API/PaymentResponse/retry$edit" class="_attribution-link">Edit this page on MDN</a>
  </p>
</div>
<div class="_attribution">
  <p class="_attribution-p">
    &copy; 2005&ndash;2018 Mozilla Developer Network and individual contributors.<br>Licensed under the Creative Commons Attribution-ShareAlike License v2.5 or later.<br>
    <a href="https://developer.mozilla.org/en-US/docs/Web/API/PaymentResponse/retry" class="_attribution-link">https://developer.mozilla.org/en-US/docs/Web/API/PaymentResponse/retry</a>
  </p>
</div>
