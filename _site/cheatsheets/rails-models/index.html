<h2 id="generating">Generating</h2>

<h3 id="generating-1">Generating</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ rails g model User
</code></pre></div></div>

<h2 id="using-models">Using models</h2>

<h3 id="query-methods">Query methods</h3>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">items</span> <span class="o">=</span> <span class="no">Model</span>
  <span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">first_name: </span><span class="s1">'Harvey'</span><span class="p">)</span>
  <span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s1">'id = 3'</span><span class="p">)</span>
  <span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s1">'id = ?'</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="p">.</span><span class="nf">order</span><span class="p">(</span><span class="ss">:title</span><span class="p">)</span>
  <span class="p">.</span><span class="nf">order</span><span class="p">(</span><span class="ss">title: :desc</span><span class="p">)</span>
  <span class="p">.</span><span class="nf">order</span><span class="p">(</span><span class="s2">"title DESC"</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="p">.</span><span class="nf">reorder</span><span class="p">(</span><span class="ss">:title</span><span class="p">)</span>  <span class="c1"># discards other .order's</span>
  <span class="p">.</span><span class="nf">rewhere</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>     <span class="c1"># discards other .where's</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="p">.</span><span class="nf">limit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
  <span class="p">.</span><span class="nf">offset</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="p">.</span><span class="nf">uniq</span>
</code></pre></div></div>

<p>See: <a href="http://devdocs.io/rails/activerecord/querymethods">QueryMethods</a></p>

<h3 id="advanced-query-methods">Advanced query methods</h3>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">items</span> <span class="o">=</span> <span class="no">Model</span>
  <span class="p">.</span><span class="nf">select</span><span class="p">(</span><span class="ss">:id</span><span class="p">)</span>
  <span class="p">.</span><span class="nf">select</span><span class="p">([</span><span class="ss">:id</span><span class="p">,</span> <span class="ss">:name</span><span class="p">])</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>   <span class="c1"># GROUP BY name</span>
  <span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="s1">'name AS grouped_name, age'</span><span class="p">)</span>
  <span class="p">.</span><span class="nf">having</span><span class="p">(</span><span class="s1">'SUM(price) &gt; 30'</span><span class="p">)</span>  <span class="c1"># needs to be chained with .group</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="p">.</span><span class="nf">includes</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
  <span class="p">.</span><span class="nf">includes</span><span class="p">(</span><span class="ss">user: </span><span class="p">[</span><span class="ss">:articles</span><span class="p">])</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="p">.</span><span class="nf">references</span><span class="p">(</span><span class="ss">:posts</span><span class="p">)</span>
  <span class="c1"># aka: .where("posts.name = 'foo'").references(:posts)</span>
</code></pre></div></div>

<h3 id="finder-methods">Finder methods</h3>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">item</span> <span class="o">=</span> <span class="no">Model</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
<span class="n">item</span> <span class="o">=</span> <span class="no">Model</span><span class="p">.</span><span class="nf">find_by_email</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
<span class="n">item</span> <span class="o">=</span> <span class="no">Model</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">email: </span><span class="n">email</span><span class="p">).</span><span class="nf">first</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Model</span>
  <span class="p">.</span><span class="nf">exists?</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
  <span class="p">.</span><span class="nf">exists?</span><span class="p">(</span><span class="ss">name: </span><span class="s2">"David"</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="p">.</span><span class="nf">first</span>
  <span class="p">.</span><span class="nf">last</span>
  <span class="p">.</span><span class="nf">find_nth</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="p">[</span><span class="n">offset</span><span class="p">])</span>
</code></pre></div></div>

<p>See: <a href="http://devdocs.io/rails/activerecord/findermethods">FinderMethods</a></p>

<h3 id="persistence">Persistence</h3>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">item</span><span class="p">.</span><span class="nf">new_record?</span>
<span class="n">item</span><span class="p">.</span><span class="nf">persisted?</span>
<span class="n">item</span><span class="p">.</span><span class="nf">destroyed?</span>

<span class="n">item</span><span class="p">.</span><span class="nf">serialize_hash</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">item</span><span class="p">.</span><span class="nf">save</span>
<span class="n">item</span><span class="p">.</span><span class="nf">save!</span>      <span class="c1"># Same as above, but raises an Exception</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">item</span><span class="p">.</span><span class="nf">update</span>  <span class="ss">name: </span><span class="s1">'John'</span>  <span class="c1"># Saves immediately</span>
<span class="n">item</span><span class="p">.</span><span class="nf">update!</span> <span class="ss">name: </span><span class="s1">'John'</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">item</span><span class="p">.</span><span class="nf">update_column</span>  <span class="ss">:name</span><span class="p">,</span> <span class="s1">'John'</span>  <span class="c1"># skips validations and callbacks</span>
<span class="n">item</span><span class="p">.</span><span class="nf">update_columns</span>  <span class="ss">name: </span><span class="s1">'John'</span>
<span class="n">item</span><span class="p">.</span><span class="nf">update_columns!</span> <span class="ss">name: </span><span class="s1">'John'</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">item</span><span class="p">.</span><span class="nf">touch</span>                 <span class="c1"># updates :updated_at</span>
<span class="n">item</span><span class="p">.</span><span class="nf">touch</span> <span class="ss">:published_at</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">item</span><span class="p">.</span><span class="nf">destroy</span>
<span class="n">item</span><span class="p">.</span><span class="nf">delete</span>  <span class="c1"># skips callbacks</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Model</span><span class="p">.</span><span class="nf">create</span>     <span class="c1"># Same an #new then #save</span>
<span class="no">Model</span><span class="p">.</span><span class="nf">create!</span>    <span class="c1"># Same as above, but raises an Exception</span>
</code></pre></div></div>

<p>See: <a href="http://devdocs.io/rails/activerecord/persistence">Persistence</a></p>

<h3 id="attribute-assignment">Attribute Assignment</h3>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">item</span><span class="p">.</span><span class="nf">attributes</span>                      <span class="c1"># #&lt;Hash&gt;</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">item</span><span class="p">.</span><span class="nf">attributes</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">name: </span><span class="s1">'John'</span> <span class="p">}</span>   <span class="c1"># Merges attributes in. Doesn't save.</span>
<span class="n">item</span><span class="p">.</span><span class="nf">assign_attributes</span> <span class="ss">name: </span><span class="s1">'John'</span>  <span class="c1"># Same as above</span>
</code></pre></div></div>

<p>See: <a href="http://devdocs.io/rails/activerecord/attributeassignment">AttributeAssignment</a></p>

<h3 id="dirty">Dirty</h3>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">item</span><span class="p">.</span><span class="nf">changed?</span>
<span class="n">item</span><span class="p">.</span><span class="nf">changed</span>             <span class="c1"># ['name']</span>
<span class="n">item</span><span class="p">.</span><span class="nf">changed_attributes</span>  <span class="c1"># { 'name' =&gt; 'Bob' } - original values</span>
<span class="n">item</span><span class="p">.</span><span class="nf">changes</span>             <span class="c1"># { 'name' =&gt; ['Bob', 'Robert'] }</span>
<span class="n">item</span><span class="p">.</span><span class="nf">previous_changes</span>    <span class="c1"># available after #save</span>
<span class="n">item</span><span class="p">.</span><span class="nf">restore_attributes</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">item</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s1">'Robert'</span>
<span class="n">item</span><span class="p">.</span><span class="nf">name_was</span>         <span class="c1"># 'Bob'</span>
<span class="n">item</span><span class="p">.</span><span class="nf">name_change</span>      <span class="c1"># [ 'Bob', 'Robert' ]</span>
<span class="n">item</span><span class="p">.</span><span class="nf">name_changed?</span>    <span class="c1"># true</span>
<span class="n">item</span><span class="p">.</span><span class="nf">name_changed?</span><span class="p">(</span><span class="ss">from: </span><span class="s1">'Bob'</span><span class="p">,</span> <span class="ss">to: </span><span class="s1">'Robert'</span><span class="p">)</span>
</code></pre></div></div>

<p>See: <a href="http://devdocs.io/rails/activemodel/dirty">Dirty</a></p>

<h3 id="validations">Validations</h3>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">item</span><span class="p">.</span><span class="nf">valid?</span>
<span class="n">item</span><span class="p">.</span><span class="nf">invalid?</span>
</code></pre></div></div>

<p>See: <a href="http://devdocs.io/rails/activerecord/validations">Validations</a></p>

<h3 id="calculations">Calculations</h3>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Person</span><span class="p">.</span><span class="nf">count</span>
<span class="no">Person</span><span class="p">.</span><span class="nf">count</span><span class="p">(</span><span class="ss">:age</span><span class="p">)</span>    <span class="c1"># counts non-nil's</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Person</span><span class="p">.</span><span class="nf">average</span><span class="p">(</span><span class="ss">:age</span><span class="p">)</span>
<span class="no">Person</span><span class="p">.</span><span class="nf">maximum</span><span class="p">(</span><span class="ss">:age</span><span class="p">)</span>
<span class="no">Person</span><span class="p">.</span><span class="nf">minimum</span><span class="p">(</span><span class="ss">:age</span><span class="p">)</span>
<span class="no">Person</span><span class="p">.</span><span class="nf">sum</span><span class="p">(</span><span class="s1">'2 * age'</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Person</span><span class="p">.</span><span class="nf">calculate</span><span class="p">(</span><span class="ss">:count</span><span class="p">,</span> <span class="ss">:all</span><span class="p">)</span>
</code></pre></div></div>

<p>Advanced:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Person</span><span class="p">.</span><span class="nf">distinct</span><span class="p">.</span><span class="nf">count</span>
<span class="no">Person</span><span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="ss">:city</span><span class="p">).</span><span class="nf">count</span>
</code></pre></div></div>

<p>See: <a href="http://devdocs.io/rails/activerecord/calculations">Calculations</a></p>

<h3 id="dynamic-attribute-based-finders">Dynamic attribute-based finders</h3>

<p class="-setup">Given a field called <code class="highlighter-rouge">name</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Returns one record</span>
<span class="no">Person</span><span class="p">.</span><span class="nf">find_by_name</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
<span class="no">Person</span><span class="p">.</span><span class="nf">find_last_by_name</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
<span class="no">Person</span><span class="p">.</span><span class="nf">find_or_create_by_name</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
<span class="no">Person</span><span class="p">.</span><span class="nf">find_or_initialize_by_name</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Returns a list of records</span>
<span class="no">Person</span><span class="p">.</span><span class="nf">find_all_by_name</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Add a bang to make it raise an exception</span>
<span class="no">Person</span><span class="p">.</span><span class="nf">find_by_name!</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># You may use `scoped` instead of `find`</span>
<span class="no">Person</span><span class="p">.</span><span class="nf">scoped_by_user_name</span>
</code></pre></div></div>

<h2 id="associations">Associations</h2>

<h3 id="associations-1">Associations</h3>

<ul>
  <li><code class="highlighter-rouge">belongs_to</code></li>
  <li><code class="highlighter-rouge">has_one</code></li>
  <li><code class="highlighter-rouge">has_many</code></li>
  <li><code class="highlighter-rouge">has_many :through</code></li>
  <li><code class="highlighter-rouge">has_one :through</code></li>
  <li><code class="highlighter-rouge">has_and_belongs_to_many</code></li>
</ul>

<h3 id="has-many">Has many</h3>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">belongs_to</span> <span class="ss">:parent</span><span class="p">,</span> <span class="ss">:foreign_key</span> <span class="o">=&gt;</span> <span class="s1">'parent_id'</span> <span class="ss">class_name: </span><span class="s1">'Folder'</span>
<span class="n">has_many</span> <span class="ss">:folders</span><span class="p">,</span> <span class="ss">:foreign_key</span> <span class="o">=&gt;</span> <span class="s1">'parent_id'</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s1">'Folder'</span>

<span class="n">has_many</span> <span class="ss">:comments</span><span class="p">,</span>                <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">order</span><span class="p">(</span><span class="s1">'posted_on DESC'</span><span class="p">)</span> <span class="p">}</span>
<span class="n">has_many</span> <span class="ss">:comments</span><span class="p">,</span>    <span class="ss">:include</span>    <span class="o">=&gt;</span> <span class="ss">:author</span>
<span class="n">has_many</span> <span class="ss">:people</span><span class="p">,</span>      <span class="ss">:class_name</span> <span class="o">=&gt;</span> <span class="s2">"Person"</span>
<span class="n">has_many</span> <span class="ss">:people</span><span class="p">,</span>      <span class="ss">:conditions</span> <span class="o">=&gt;</span> <span class="s2">"deleted = 0"</span>
<span class="n">has_many</span> <span class="ss">:tracks</span><span class="p">,</span>                  <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">order</span><span class="p">(</span><span class="ss">:position</span><span class="p">)</span> <span class="p">}</span>
<span class="n">has_many</span> <span class="ss">:comments</span><span class="p">,</span>    <span class="ss">:dependent</span>  <span class="o">=&gt;</span> <span class="ss">:nullify</span>
<span class="n">has_many</span> <span class="ss">:comments</span><span class="p">,</span>    <span class="ss">:dependent</span>  <span class="o">=&gt;</span> <span class="ss">:destroy</span>
<span class="n">has_many</span> <span class="ss">:tags</span><span class="p">,</span>        <span class="ss">:as</span>         <span class="o">=&gt;</span> <span class="ss">:taggable</span>
<span class="n">has_many</span> <span class="ss">:reports</span><span class="p">,</span>     <span class="ss">:readonly</span>   <span class="o">=&gt;</span> <span class="kp">true</span>
<span class="n">has_many</span> <span class="ss">:subscribers</span><span class="p">,</span> <span class="ss">:through</span>    <span class="o">=&gt;</span> <span class="ss">:subscriptions</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s2">"User"</span><span class="p">,</span> <span class="ss">:source</span> <span class="o">=&gt;</span> <span class="ss">:user</span>
<span class="n">has_many</span> <span class="ss">:subscribers</span><span class="p">,</span> <span class="ss">:finder_sql</span> <span class="o">=&gt;</span>
    <span class="s1">'SELECT DISTINCT people.* '</span> <span class="o">+</span>
    <span class="s1">'FROM people p, post_subscriptions ps '</span> <span class="o">+</span>
    <span class="s1">'WHERE ps.post_id = #{id} AND ps.person_id = p.id '</span> <span class="o">+</span>
    <span class="s1">'ORDER BY p.first_name'</span>
</code></pre></div></div>

<h3 id="belongs-to">belongs to</h3>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span>
  <span class="ss">:dependent</span>      <span class="o">=&gt;</span> <span class="ss">:destroy</span>    <span class="c1"># or :delete</span>

  <span class="ss">:class_name</span>     <span class="o">=&gt;</span> <span class="s2">"Person"</span>
  <span class="ss">:select</span>         <span class="o">=&gt;</span> <span class="s2">"*"</span>
  <span class="ss">:counter_cache</span>  <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="ss">:counter_cache</span>  <span class="o">=&gt;</span> <span class="ss">:custom_counter</span>
  <span class="ss">:include</span>        <span class="o">=&gt;</span> <span class="s2">"Book"</span>
  <span class="ss">:readonly</span>       <span class="o">=&gt;</span> <span class="kp">true</span>

  <span class="ss">:conditions</span>     <span class="o">=&gt;</span> <span class="s1">'published = true'</span>

  <span class="ss">:touch</span>          <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="ss">:touch</span>          <span class="o">=&gt;</span> <span class="ss">:authors_last_updated_at</span>

  <span class="ss">:primary_key</span>    <span class="o">=&gt;</span> <span class="s2">"name"</span>
  <span class="ss">:foreign_key</span>    <span class="o">=&gt;</span> <span class="s2">"author_name"</span>
</code></pre></div></div>

<h3 id="many-to-many">Many-to-many</h3>

<p class="-setup">If you have a join model:</p>

<div data-line="2,3" class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Programmer</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_many</span> <span class="ss">:assignments</span>
  <span class="n">has_many</span> <span class="ss">:projects</span><span class="p">,</span> <span class="ss">:through</span> <span class="o">=&gt;</span> <span class="ss">:assignments</span>
<span class="k">end</span>
</code></pre></div></div>

<div data-line="2,3" class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Project</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_many</span> <span class="ss">:assignments</span>
  <span class="n">has_many</span> <span class="ss">:programmers</span><span class="p">,</span> <span class="ss">:through</span> <span class="o">=&gt;</span> <span class="ss">:assignments</span>
<span class="k">end</span>
</code></pre></div></div>

<div data-line="2,3" class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Assignment</span>
  <span class="n">belongs_to</span> <span class="ss">:project</span>
  <span class="n">belongs_to</span> <span class="ss">:programmer</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="many-to-many-habtm">Many-to-many (HABTM)</h3>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">has_and_belongs_to_many</span> <span class="ss">:projects</span>
<span class="n">has_and_belongs_to_many</span> <span class="ss">:projects</span><span class="p">,</span> <span class="ss">:include</span> <span class="o">=&gt;</span> <span class="p">[</span> <span class="ss">:milestones</span><span class="p">,</span> <span class="ss">:manager</span> <span class="p">]</span>
<span class="n">has_and_belongs_to_many</span> <span class="ss">:nations</span><span class="p">,</span> <span class="ss">:class_name</span> <span class="o">=&gt;</span> <span class="s2">"Country"</span>
<span class="n">has_and_belongs_to_many</span> <span class="ss">:categories</span><span class="p">,</span> <span class="ss">:join_table</span> <span class="o">=&gt;</span> <span class="s2">"prods_cats"</span>
<span class="n">has_and_belongs_to_many</span> <span class="ss">:categories</span><span class="p">,</span> <span class="ss">:readonly</span> <span class="o">=&gt;</span> <span class="kp">true</span>
<span class="n">has_and_belongs_to_many</span> <span class="ss">:active_projects</span><span class="p">,</span> <span class="ss">:join_table</span> <span class="o">=&gt;</span> <span class="s1">'developers_projects'</span><span class="p">,</span> <span class="ss">:delete_sql</span> <span class="o">=&gt;</span>
<span class="s2">"DELETE FROM developers_projects WHERE active=1 AND developer_id = </span><span class="si">#{</span><span class="nb">id</span><span class="si">}</span><span class="s2"> AND project_id = </span><span class="si">#{</span><span class="n">record</span><span class="p">.</span><span class="nf">id</span><span class="si">}</span><span class="s2">"</span>
</code></pre></div></div>

<h3 id="polymorphic-associations">Polymorphic associations</h3>

<div data-line="2" class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Post</span>
  <span class="n">has_many</span> <span class="ss">:attachments</span><span class="p">,</span> <span class="ss">as: :parent</span>
<span class="k">end</span>
</code></pre></div></div>

<div data-line="2" class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Image</span>
  <span class="n">belongs_to</span> <span class="ss">:parent</span><span class="p">,</span> <span class="ss">polymorphic: </span><span class="kp">true</span>
<span class="k">end</span>
</code></pre></div></div>

<p>And in migrations:</p>

<div data-line="2" class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">create_table</span> <span class="ss">:images</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">references</span> <span class="ss">:post</span><span class="p">,</span> <span class="ss">polymorphic: </span><span class="kp">true</span>
<span class="k">end</span>
</code></pre></div></div>

<h2 id="validation">Validation</h2>

<h3 id="validation-1">Validation</h3>

<div class="language-ruby -setup highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Person</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</code></pre></div></div>

<div data-line="2" class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c1"># Presence</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span>     <span class="ss">presence: </span><span class="kp">true</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c1"># Acceptance</span>
  <span class="n">validates</span> <span class="ss">:terms</span><span class="p">,</span>    <span class="ss">acceptance: </span><span class="kp">true</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c1"># Confirm</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span>    <span class="ss">confirmation: </span><span class="kp">true</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c1"># Unique</span>
  <span class="n">validates</span> <span class="ss">:slug</span><span class="p">,</span>     <span class="ss">uniqueness: </span><span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:slug</span><span class="p">,</span>     <span class="ss">uniqueness: </span><span class="p">{</span> <span class="ss">case_sensitive: </span><span class="kp">false</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:holiday</span><span class="p">,</span>  <span class="ss">uniqueness: </span><span class="p">{</span> <span class="ss">scope: :year</span><span class="p">,</span> <span class="ss">message: </span><span class="s1">'yearly only'</span> <span class="p">}</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c1"># Format</span>
  <span class="n">validates</span> <span class="ss">:code</span><span class="p">,</span>     <span class="ss">format: </span><span class="sr">/regex/</span>
  <span class="n">validates</span> <span class="ss">:code</span><span class="p">,</span>     <span class="ss">format: </span><span class="p">{</span> <span class="ss">with: </span><span class="sr">/regex/</span> <span class="p">}</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c1"># Length</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span>     <span class="ss">length: </span><span class="p">{</span> <span class="ss">minimum: </span><span class="mi">2</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:bio</span><span class="p">,</span>      <span class="ss">length: </span><span class="p">{</span> <span class="ss">maximum: </span><span class="mi">500</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">length: </span><span class="p">{</span> <span class="ss">in: </span><span class="o">=&gt;</span> <span class="mi">6</span><span class="o">..</span><span class="mi">20</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:number</span><span class="p">,</span>   <span class="ss">length: </span><span class="p">{</span> <span class="ss">is: </span><span class="o">=&gt;</span> <span class="mi">6</span> <span class="p">}</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c1"># Include/exclude</span>
  <span class="n">validates</span> <span class="ss">:gender</span><span class="p">,</span>   <span class="ss">inclusion: </span><span class="sx">%w(male female)</span>
  <span class="n">validates</span> <span class="ss">:gender</span><span class="p">,</span>   <span class="ss">inclusion: </span><span class="p">{</span> <span class="ss">in: </span><span class="sx">%w(male female)</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:lol</span><span class="p">,</span>      <span class="ss">exclusion: </span><span class="sx">%w(xyz)</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c1"># Numeric</span>
  <span class="n">validates</span> <span class="ss">:points</span><span class="p">,</span>   <span class="ss">numericality: </span><span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:played</span><span class="p">,</span>   <span class="ss">numericality: </span><span class="p">{</span> <span class="ss">only_integer: </span><span class="kp">true</span> <span class="p">}</span>
  <span class="c1"># ... greater_than, greater_than_or_equal_to,</span>
  <span class="c1"># ... less_than, less_than_or_equal_to</span>
  <span class="c1"># ... odd, even, equal_to</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c1"># Validate the associated records to ensure they're valid as well</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
  <span class="n">validates_associated</span> <span class="ss">:books</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c1"># Length (full options)</span>
  <span class="n">validates</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">length: </span><span class="p">{</span>
    <span class="ss">minimum:   </span><span class="mi">300</span><span class="p">,</span>
    <span class="ss">maximum:   </span><span class="mi">400</span><span class="p">,</span>
    <span class="ss">tokenizer: </span><span class="nb">lambda</span> <span class="p">{</span> <span class="o">|</span><span class="n">str</span><span class="o">|</span> <span class="n">str</span><span class="p">.</span><span class="nf">scan</span><span class="p">(</span><span class="sr">/\w+/</span><span class="p">)</span> <span class="p">},</span>
    <span class="ss">too_short: </span><span class="s2">"must have at least %{count} words"</span><span class="p">,</span>
    <span class="ss">too_long:  </span><span class="s2">"must have at most %{count} words"</span> <span class="p">}</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c1"># Multiple</span>
  <span class="n">validates</span> <span class="ss">:login</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c1"># Conditional</span>
  <span class="n">validates</span> <span class="ss">:description</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">if: :published?</span>
  <span class="n">validates</span> <span class="ss">:description</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">if: </span><span class="nb">lambda</span> <span class="p">{</span> <span class="o">|</span><span class="n">obj</span><span class="o">|</span> <span class="o">..</span> <span class="p">}</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">validates</span> <span class="ss">:title</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">on: :save</span>   <span class="c1"># :save | :create | :update</span>
</code></pre></div></div>

<div class="language-ruby -setup highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">end</span>
</code></pre></div></div>

<h3 id="custom-validations">Custom validations</h3>

<div data-line="2" class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Person</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">validate</span> <span class="ss">:foo_cant_be_nil</span>

  <span class="k">def</span> <span class="nf">foo_cant_be_nil</span>
    <span class="n">errors</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="ss">:foo</span><span class="p">,</span> <span class="s1">'cant be nil'</span><span class="p">)</span>  <span class="k">if</span> <span class="n">foo</span><span class="p">.</span><span class="nf">nil?</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="errors">Errors</h3>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">record</span><span class="p">.</span><span class="nf">errors</span><span class="p">.</span><span class="nf">valid?</span>      <span class="c1"># → false</span>
<span class="n">record</span><span class="p">.</span><span class="nf">errors</span>             <span class="c1"># → { :name =&gt; ["can't be blank"] }</span>
<span class="n">record</span><span class="p">.</span><span class="nf">errors</span><span class="p">.</span><span class="nf">messages</span>    <span class="c1"># → { :name =&gt; ["can't be blank"] }</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">record</span><span class="p">.</span><span class="nf">errors</span><span class="p">[</span><span class="ss">:name</span><span class="p">].</span><span class="nf">any?</span>
</code></pre></div></div>

<h2 id="other-api">Other API</h2>

<h3 id="callbacks">Callbacks</h3>

<ul>
  <li><a href="http://guides.rubyonrails.org/active_record_validations_callbacks.html">Guides: callbacks</a></li>
</ul>

<h3 id="mass-updates">Mass updates</h3>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Updates person id 15</span>
<span class="no">Person</span><span class="p">.</span><span class="nf">update</span> <span class="mi">15</span><span class="p">,</span> <span class="ss">name: </span><span class="s2">"John"</span><span class="p">,</span> <span class="ss">age: </span><span class="mi">24</span>
<span class="no">Person</span><span class="p">.</span><span class="nf">update</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="p">[{</span><span class="ss">name: </span><span class="s2">"John"</span><span class="p">},</span> <span class="p">{</span><span class="ss">name: </span><span class="s2">"foo"</span><span class="p">}]</span>
</code></pre></div></div>

<h3 id="joining">Joining</h3>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Basic joins</span>
<span class="no">Student</span><span class="p">.</span><span class="nf">joins</span><span class="p">(</span><span class="ss">:schools</span><span class="p">).</span><span class="nf">where</span><span class="p">(</span><span class="ss">schools: </span><span class="p">{</span> <span class="ss">type: </span><span class="s1">'public'</span> <span class="p">})</span>
<span class="no">Student</span><span class="p">.</span><span class="nf">joins</span><span class="p">(</span><span class="ss">:schools</span><span class="p">).</span><span class="nf">where</span><span class="p">(</span><span class="s1">'schools.type'</span> <span class="o">=&gt;</span> <span class="s1">'public'</span> <span class="p">)</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Multiple associations</span>
<span class="no">Article</span><span class="p">.</span><span class="nf">joins</span><span class="p">(</span><span class="ss">:category</span><span class="p">,</span> <span class="ss">:comments</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Nested associations</span>
<span class="no">Article</span><span class="p">.</span><span class="nf">joins</span><span class="p">(</span><span class="ss">comments: :guest</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># SQL</span>
<span class="no">Author</span><span class="p">.</span><span class="nf">joins</span><span class="p">(</span>
  <span class="s1">'INNER JOIN posts '</span> <span class="o">+</span>
  <span class="s1">'ON posts.author_id = authors.id '</span> <span class="o">+</span>
  <span class="s1">'AND posts.published = "t"'</span>
<span class="p">)</span>
</code></pre></div></div>

<h3 id="where-interpolation">Where interpolation</h3>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">where</span><span class="p">(</span><span class="s1">'name = ?'</span><span class="p">,</span> <span class="s1">'John'</span><span class="p">)</span>
<span class="n">where</span><span class="p">([</span><span class="s1">'name = :name'</span><span class="p">,</span> <span class="p">{</span> <span class="ss">name: </span><span class="s1">'John'</span> <span class="p">}])</span>
</code></pre></div></div>

<h3 id="serialize">Serialize</h3>

<div data-line="2" class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">serialize</span> <span class="ss">:preferences</span>
<span class="k">end</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
  <span class="ss">preferences: </span><span class="p">{</span>
    <span class="s1">'background'</span> <span class="o">=&gt;</span> <span class="s1">'black'</span><span class="p">,</span>
    <span class="s1">'display'</span> <span class="o">=&gt;</span> <span class="s1">'large'</span>
  <span class="p">}</span>
<span class="p">)</span>
</code></pre></div></div>

<p>You can also specify a class option as the second parameter that’ll raise an 
exception if a serialized object is retrieved as a descendant of a class not in 
the hierarchy.</p>

<div data-line="3" class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Only Hash allowed!</span>
<span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">serialize</span> <span class="ss">:preferences</span><span class="p">,</span> <span class="no">Hash</span>
<span class="k">end</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Reading it raises SerializationTypeMismatch</span>
<span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">preferences: </span><span class="sx">%w(one two three)</span><span class="p">)</span>
<span class="no">User</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="nf">id</span><span class="p">).</span><span class="nf">preferences</span>
</code></pre></div></div>

<h2 id="other-tricks">Other tricks</h2>

<h3 id="overriding-accessors">Overriding accessors</h3>

<div data-line="4,8" class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Song</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="c1"># Uses an integer of seconds to hold the length of the song</span>

  <span class="k">def</span> <span class="nf">length</span><span class="o">=</span><span class="p">(</span><span class="n">minutes</span><span class="p">)</span>
    <span class="n">write_attribute</span><span class="p">(</span><span class="ss">:length</span><span class="p">,</span> <span class="n">minutes</span><span class="p">.</span><span class="nf">to_i</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">length</span>
    <span class="n">read_attribute</span><span class="p">(</span><span class="ss">:length</span><span class="p">)</span> <span class="o">/</span> <span class="mi">60</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>See: <a href="http://api.rubyonrails.org/classes/ActiveRecord/Base.html">http://api.rubyonrails.org/classes/ActiveRecord/Base.html</a></p>

<h2 id="callbacks-1">Callbacks</h2>

<ul>
  <li>after_create</li>
  <li>after_initialize</li>
  <li>after_validation</li>
  <li>after_save</li>
  <li>after_commit</li>
</ul>
