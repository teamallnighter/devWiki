<h2 id="architecture">Architecture</h2>

<ul>
  <li>
    <p><strong>Dispatchers</strong> receive <em>actions</em> that get dispatched to its listeners.</p>
  </li>
  <li>
    <p><strong>Stores</strong> are objects that store data, usually changed from a dispatcher listener.</p>
  </li>
  <li>
    <p><strong>Views</strong> are React components that listen to Store changes, or emit <em>actions</em> to the dispatcher.</p>
  </li>
</ul>

<hr />

<h2 id="dispatcher">Dispatcher</h2>

<h3 id="pub-sub">Pub-sub</h3>
<p><a href="http://facebook.github.io/flux/docs/dispatcher.html">A dispatcher</a> emits events (<code class="highlighter-rouge">.dispatch()</code>) to its listeners (<code class="highlighter-rouge">.register(fn)</code>).</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">Dispatcher</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">flux</span><span class="dl">'</span><span class="p">).</span><span class="nx">Dispatcher</span><span class="p">;</span>

<span class="nx">d</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Dispatcher</span><span class="p">();</span>

<span class="c1">// send</span>
<span class="nx">d</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">({</span> <span class="na">action</span><span class="p">:</span> <span class="dl">'</span><span class="s1">edit</span><span class="dl">'</span><span class="p">,</span> <span class="p">...</span> <span class="p">};</span>

<span class="c1">// receive</span>
<span class="nx">token</span> <span class="o">=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">payload</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">payload</span><span class="p">.</span><span class="nx">action</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">edit</span><span class="dl">'</span>
<span class="p">})</span>
</code></pre></div></div>

<h3 id="ensuring-proper-order">Ensuring proper order</h3>

<p>With multiple listeners, you can ensure one is fired after another using <code class="highlighter-rouge">.waitFor()</code>.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">token1</span> <span class="o">=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">register</span><span class="p">(...);</span>

<span class="nx">token2</span> <span class="o">=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">payload</span><span class="p">)</span> <span class="p">{</span>

  <span class="c1">// ensure receiver 1 is fired before this</span>
  <span class="nx">d</span><span class="p">.</span><span class="nx">waitFor</span><span class="p">([</span> <span class="nx">token1</span> <span class="p">]);</span>
  
  <span class="c1">// process here</span>
<span class="p">})</span>
</code></pre></div></div>

<h3 id="subclassing">Subclassing</h3>

<p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/assign">Object.assign</a> is the preferred way to subclass Dispatcher (think <code class="highlighter-rouge">$.extend</code>).<br />
You can also make <em>action creators</em>, which are shortcuts for <code class="highlighter-rouge">dispatch()</code>.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">Dispatcher</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">flux</span><span class="dl">'</span><span class="p">).</span><span class="nx">Dispatcher</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">assign</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">object-assign</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">AppDispatcher</span> <span class="o">=</span> <span class="nx">assign</span><span class="p">({},</span> <span class="nx">Dispatcher</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="p">{</span>

  <span class="c1">// action creator</span>
  <span class="nx">handleViewAction</span><span class="p">(</span><span class="nx">action</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">({</span>
      <span class="na">source</span><span class="p">:</span> <span class="dl">'</span><span class="s1">VIEW_ACTION</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">action</span><span class="p">:</span> <span class="nx">action</span>
    <span class="p">})</span>
  <span class="p">}</span> 

<span class="p">})</span>
</code></pre></div></div>

<hr />

<h2 id="stores">Stores</h2>

<h3 id="plain-objects">Plain objects</h3>
<p>Stores are just like objects.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">TodoStore</span> <span class="o">=</span> <span class="p">{</span> <span class="na">list</span><span class="p">:</span> <span class="p">[]</span> <span class="p">};</span>
</code></pre></div></div>

<h3 id="events">Events</h3>
<p>Sometimes they’re eventemitters, too. Usually it’s used to emit <code class="highlighter-rouge">change</code> events for views to pick up.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">TodoStore</span> <span class="o">=</span> <span class="nx">assign</span><span class="p">({},</span> <span class="nx">EventEmitter</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="p">{</span>
  <span class="p">...</span>
<span class="p">});</span>

<span class="nx">TodoStore</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="dl">'</span><span class="s1">change</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">TodoStore</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">change</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="p">...</span> <span class="p">});</span>
</code></pre></div></div>

<h3 id="model-logic">Model logic</h3>
<p>Logic can sometimes belong in stores.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span>
  <span class="nx">isAllActive</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">list</span><span class="p">.</span><span class="nx">every</span><span class="p">(</span><span class="nx">item</span> <span class="o">=&gt;</span> <span class="nx">item</span><span class="p">.</span><span class="nx">active</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h2 id="stores-and-dispatchers">Stores and dispatchers</h2>

<h3 id="instantiate">Instantiate</h3>
<p>Make a Dispatcher and Stores.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">d</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Dispatcher</span><span class="p">();</span>
<span class="nx">TabStore</span> <span class="o">=</span> <span class="p">{</span> <span class="na">tab</span><span class="p">:</span> <span class="dl">'</span><span class="s1">home</span><span class="dl">'</span> <span class="p">};</span>
</code></pre></div></div>

<h3 id="updating-data">Updating data</h3>
<p>Dispatch events to alter the store.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">d</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">({</span> <span class="na">action</span><span class="p">:</span> <span class="dl">'</span><span class="s1">tab.change</span><span class="dl">'</span><span class="p">,</span> <span class="na">tab</span><span class="p">:</span> <span class="dl">'</span><span class="s1">timeline</span><span class="dl">'</span> <span class="p">});</span>

<span class="nx">d</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">action</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">tab.change</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">TabStore</span><span class="p">.</span><span class="nx">tab</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">tab</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre></div></div>

<hr />

<h2 id="with-views">With Views</h2>

<h3 id="listen-to-dispatchers">Listen to dispatchers</h3>
<p>Views (React Components) can listen to Dispatchers.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">TodoApp</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">createClass</span><span class="p">({</span>

  <span class="nx">componentDidMount</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">token</span> <span class="o">=</span> <span class="nx">AppDispatcher</span><span class="p">.</span><span class="nx">register</span><span class="p">((</span><span class="nx">payload</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">switch</span> <span class="p">(</span><span class="nx">payload</span><span class="p">.</span><span class="nx">action</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="dl">'</span><span class="s1">tab.change</span><span class="dl">'</span><span class="p">:</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>
          <span class="c1">// ...</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">},</span>
  
  <span class="nx">componentDidUnmount</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">AppDispatcher</span><span class="p">.</span><span class="nx">unregister</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">token</span><span class="p">);</span>
  <span class="p">}</span>
  
<span class="p">});</span>
</code></pre></div></div>

<h3 id="listen-to-stores">Listen to Stores</h3>
<p>Or to Stores’s <code class="highlighter-rouge">change</code> events.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span>
  <span class="nx">componentDidMount</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">TodoStore</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">change</span><span class="dl">'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">onChange</span><span class="p">);</span>
  <span class="p">},</span>
  
  <span class="nx">componentDidUnmount</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">TodoState</span><span class="p">.</span><span class="nx">removeListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">change</span><span class="dl">'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">onChange</span><span class="p">);</span>
  <span class="p">},</span>
  
  <span class="nx">onChange</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h3 id="also-see">Also see</h3>

<ul>
  <li><a href="http://facebook.github.io/flux/docs/dispatcher.html">Dispatcher API</a></li>
  <li><a href="react.html">React cheatsheet</a></li>
  <li><a href="https://github.com/facebook/flux/blob/master/src/Dispatcher.js">Dispatcher.js source</a></li>
  <li><a href="https://github.com/facebook/flux/tree/master/examples/flux-todomvc">Flux-todomvc explanation</a></li>
</ul>

